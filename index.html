function establecerImagen(img, imagen) {
        let intentos = [
            `https://raw.githubusercontent.com/tecnomaslanus/ps2/main/img/${imagen}.jpg`,
            `https://raw.githubusercontent.com/tecnomaslanus/ps2/main/img/${imagen}.png`,
            `https://raw.githubusercontent.com/tecnomaslanus/ps2/main/img2/${imagen}.jpg`,
            `https://raw.githubusercontent.com/tecnomaslanus/ps2/main/img2/${imagen}.png`,
            `https://raw.githubusercontent.com/tecnomaslanus/ps2/main/img2/default.jpg`
        ];
        let index = 0;
        img.src = intentos[index];
        img.onerror = () => {
            index++;
            if (index < intentos.length) {
                img.src = intentos[index];
            }
        };
    }

    function cargarCatalogo() {
        fetch('list.csv')
            .then(response => response.text())
            .then(data => {
                let juegos = data.split('\n');
                juegos.forEach((juego, index) => {
                    if (index > 0 && juego.trim() !== '') {
                        let partes = juego.split(',');
                        let nombre = partes[0].trim();
                        let codigo = partes[1].trim();
                        let imagen = `${codigo}_COV`;

                        let item = document.createElement('div');
                        item.classList.add('item');
                        item.setAttribute('data-nombre', nombre);
                        
                        let img = document.createElement('img');
                        establecerImagen(img, imagen);

                        let p = document.createElement('p');
                        p.textContent = nombre;

                        item.appendChild(img);
                        item.appendChild(p);
                        document.getElementById('catalogo').appendChild(item);
                        
                        item.addEventListener('click', () => {
                            item.classList.toggle('selected');
                            actualizarContador();
                        });
                    }
                });
            })
            .catch(error => console.error('Error al cargar el CSV:', error));
    }

    function actualizarContador() {
        let seleccionados = document.querySelectorAll('.item.selected').length;
        document.getElementById('contador').textContent = seleccionados;
    }

    function filtrarJuegos() {
        let input = document.getElementById("busqueda").value.toLowerCase();
        let items = document.querySelectorAll(".item");
        items.forEach(item => {
            let nombre = item.getAttribute("data-nombre").toLowerCase();
            item.style.display = nombre.includes(input) ? "flex" : "none";
        });
    }

    function guardarCSV() {
        let seleccionados = document.querySelectorAll('.item.selected');
        let nombres = Array.from(seleccionados).map(item => item.getAttribute('data-nombre'));
        
        if (nombres.length === 0) {
            alert("Seleccioná al menos un juego.");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8," + nombres.join("\n");
        let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        saveAs(blob, "juegos_seleccionados.csv");
    }

    // Función para enviar el archivo CSV al script de Google Apps
    async function generarCSV() {
        let seleccionados = document.querySelectorAll('.item.selected');
        let nombres = Array.from(seleccionados).map(item => item.getAttribute('data-nombre'));

        if (nombres.length === 0) {
            alert("Seleccioná al menos un juego.");
            return;
        }

        let csvContent = nombres.join("\n");
        let blob = new Blob([csvContent], { type: "text/csv" });

        // Llamada a la función que sube el archivo a Google Apps Script
        await subirArchivoAGoogleDrive(blob);
    }

    // Función para subir el archivo CSV a Google Apps Script
    async function subirArchivoAGoogleDrive(csvBlob) {
        let formData = new FormData();
        formData.append("file", csvBlob, "juegos_seleccionados.csv");

        let response = await fetch("https://script.google.com/macros/s/AKfycbx4VHT3rP12N_p5CSbOr6B18Q-LpcNqlP6bQH5gza7qnWayr3X6152cJysgSQ_0zXah/exec", { 
            method: "POST",
            body: formData
        });

        if (response.ok) {
            alert("Archivo subido. Se enviará por correo.");
        } else {
            alert("Error al subir archivo.");
        }
    }
